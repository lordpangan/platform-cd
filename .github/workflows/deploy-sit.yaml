name: deploy-sit

on:
  repository_dispatch:
    types: [ deploy-sit ]   # triggered from microservices-app
  workflow_dispatch:
    inputs:
      service: { required: true }
      tag:     { required: true }

env:
  REGISTRY: ${{ vars.REGISTRY || 'ghcr.io/lordpangan' }}
  DOMAIN:   ${{ vars.DOMAIN   || 'orderoneline.com' }}

jobs:
  sit:
    runs-on: ubuntu-proxmox
    environment: SIT
    permissions:
      contents: read
      deployments: write
      checks: write
      id-token: write
      pull-requests: write
      issues: write

    steps:
      - uses: actions/checkout@v4

      - name: Write kubeconfig from base64
        run: |
          printf '%s' "${KUBECONFIG_B64}" | base64 -d > "$RUNNER_TEMP/kubeconfig"
          echo "KUBECONFIG=$RUNNER_TEMP/kubeconfig" >> $GITHUB_ENV
        env:
          KUBECONFIG_B64: ${{ secrets.KUBECONFIG }}

      - run: kubectl cluster-info

      - name: Determine service + tag
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          SRV="${{ github.event.client_payload.service || inputs.service }}"
          TAG="${{ github.event.client_payload.tag || inputs.tag }}"

          if [[ -z "$SRV" || -z "$TAG" ]]; then
            echo "::error::Missing service or tag"
            exit 1
          fi

          # Auto-derive deploy/container name by trimming "-service" suffix if present
          DEPLOY="${SRV%-service}"
          CONTAINER="$DEPLOY"

          echo "service=$SRV" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "deploy=$DEPLOY" >> $GITHUB_OUTPUT
          echo "container=$CONTAINER" >> $GITHUB_OUTPUT

          echo "ðŸš€ Deploying $SRV:$TAG â†’ $DEPLOY"

      - name: Apply SIT (by TAG) and wait
        run: |
          set -euo pipefail
          kubectl apply -k ops/k8s/overlays/sit
          kubectl -n sit set image deploy/${{ steps.meta.outputs.deploy }} \
            ${{ steps.meta.outputs.container }}=${{ env.REGISTRY }}/${{ steps.meta.outputs.service }}:${{ steps.meta.outputs.tag }}
          kubectl -n sit rollout restart deploy/${{ steps.meta.outputs.deploy }}
          kubectl -n sit rollout status deploy/${{ steps.meta.outputs.deploy }} --timeout=180s
          echo "âœ… ${{ steps.meta.outputs.service }} deployed successfully to SIT"

      - name: SIT smoke (Newman)
        continue-on-error: true  # temporary
        run: |
          npm install newman@6 newman-reporter-htmlextra
          npx newman run tests/sit/postman/collection.json \
            -e tests/sit/postman/env.sit.json \
            --reporters junit,cli,htmlextra \
            --reporter-junit-export sit.junit.xml \
            --reporter-htmlextra-export sit.html

      - name: Upload SIT reports
        uses: actions/upload-artifact@v4
        with:
          name: sit-reports
          path: "*.xml;*.html"

      - name: Authenticate crane with GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | crane auth login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Resolve image digest for deployed service
        id: digest
        run: |
          set -euo pipefail
          DIG=$(crane digest ${{ env.REGISTRY }}/${{ steps.meta.outputs.service }}:${{ steps.meta.outputs.tag }})
          echo "digest=$DIG" >> $GITHUB_OUTPUT
          echo "Resolved digest: $DIG"

      - name: Record release-candidate (Issue) + Summary + Slack (mock)
        env:
          DIGEST: ${{ steps.digest.outputs.digest }}
          SERVICE: ${{ steps.meta.outputs.service }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "### SIT âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- $SERVICE @ $DIGEST" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          TITLE="release-candidate"
          BODY=$'Service: '"$SERVICE"$'\nDigest: '"$DIGEST"$'\n\nSIT smoke tests complete.'

          gh label create "release-candidate" --color 0366d6 || true

          ISSUE=$(gh issue list --search "$TITLE in:title state:open" --json number --jq '.[0].number' || true)
          if [ -z "$ISSUE" ]; then
            gh issue create -t "$TITLE" -b "$BODY" -l release-candidate
          else
            gh issue comment "$ISSUE" -b "$BODY"
          fi

          PAYLOAD=$(jq -n --arg env "SIT" --arg service "$SERVICE" --arg url "http://api.${{ env.DOMAIN }}" \
            '{text:"SIT deployment complete",env:$env,service:$service,url:$url}')

          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -s -X POST -H 'content-type: application/json' --data "$PAYLOAD" "$SLACK_WEBHOOK_URL" || true
          else
            {
              echo "#### Slack (mock)"
              echo ""
              echo '```json'
              echo "$PAYLOAD"
              echo '```'
            } >> $GITHUB_STEP_SUMMARY
          fi

      - name: Deployment (SIT)
        uses: chrnorm/deployment-action@v2
        with:
          token: ${{ github.token }}
          environment: SIT
          ref: ${{ github.sha }}
          payload: "{\"service\":\"${{ steps.meta.outputs.service }}\",\"url\":\"http://sit-api.${{ env.DOMAIN }}\"}"
