name: deploy-sit

on:
  repository_dispatch:
    types: [ deploy-sit ]   # triggered from microservices-app
  workflow_dispatch:
    inputs:
      service: { required: true }
      tag:     { required: true }

env:
  REGISTRY: ${{ vars.REGISTRY || 'ghcr.io/lordpangan' }}
  DOMAIN:   ${{ vars.DOMAIN   || 'orderoneline.com' }}

jobs:
  sit:
    runs-on: ubuntu-proxmox
    environment: SIT
    permissions:
      contents: read
      deployments: write
      checks: write
      id-token: write
      pull-requests: write
      issues: write

    steps:
      - uses: actions/checkout@v4

      - name: Write kubeconfig from base64
        run: |
          printf '%s' "${KUBECONFIG_B64}" | base64 -d > "$RUNNER_TEMP/kubeconfig"
          echo "KUBECONFIG=$RUNNER_TEMP/kubeconfig" >> $GITHUB_ENV
        env:
          KUBECONFIG_B64: ${{ secrets.KUBECONFIG }}

      - run: kubectl cluster-info

      - name: Apply SIT common resources
        run: |
          set -euo pipefail
          echo "ðŸ”§ Applying common SIT resources..."
          kubectl apply -k ops/k8s/common/sit
          echo "âœ… Common SIT resources applied."

      - name: Apply SIT (simple health loop)
        id: meta
        run: |
          set -euo pipefail

          RAW_SERVICE=${{ github.event.client_payload.service || inputs.service }}
          SERVICE=${RAW_SERVICE%-service}
          TAG=${{ github.event.client_payload.tag || inputs.tag  }}
          REGISTRY=${{ env.REGISTRY }}
          echo "service=$RAW_SERVICE" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT

          echo "ðŸš€ Deploying $SERVICE:$TAG to SIT..."

          pushd ops/k8s/${SERVICE}/sit > /dev/null
            kubectl kustomize . \
            | sed "s|ghcr.io/lordpangan/${RAW_SERVICE}:local|${REGISTRY}/${RAW_SERVICE}:${TAG}|g" \
            | kubectl apply -f -
            kubectl -n sit rollout restart deploy/$SERVICE
          popd > /dev/null

          echo "ðŸ”Ž Checking health of $SERVICE for up to 5 minutes..."

          for i in {1..5}; do
            echo "â±ï¸  Attempt $i of 5..."
            
            # Check for image pull errors first
            if kubectl -n sit get pods -l app=$SERVICE --no-headers 2>/dev/null \
              | grep -E 'ImagePullBackOff|ErrImagePull'; then
              echo "âŒ Image pull error detected for $SERVICE"
              exit 1
            fi

            # Check if deployment rollout succeeded
            if kubectl -n sit rollout status deploy/$SERVICE --timeout=30s; then
              echo "âœ… $SERVICE successfully rolled out and healthy!"
              exit 0
            else
              echo "âš ï¸  $SERVICE not ready yet, retrying in 60s..."
              sleep 60
            fi
          done

          echo "âŒ $SERVICE failed to become healthy after 5 minutes."
          kubectl -n sit describe deploy/$SERVICE | tail -n 50
          exit 1

      - name: SIT smoke (Newman)
        run: |
          npm install newman@6 newman-reporter-htmlextra
          npx newman run tests/sit/postman/collection.json \
            -e tests/sit/postman/env.sit.json \
            --reporters junit,cli,htmlextra \
            --reporter-junit-export sit.junit.xml \
            --reporter-htmlextra-export sit.html

      - name: Upload SIT reports
        uses: actions/upload-artifact@v4
        with:
          name: sit-reports
          path: "*.xml;*.html"

      - name: Authenticate crane with GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | crane auth login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Resolve image digest for deployed service
        id: digest
        run: |
          set -euo pipefail
          DIG=$(crane digest ${{ env.REGISTRY }}/${{ steps.meta.outputs.service }}:${{ steps.meta.outputs.tag }})
          echo "digest=$DIG" >> $GITHUB_OUTPUT
          echo "Resolved digest: $DIG"

      - name: Record release-candidate (Issue) + Summary + Slack (mock)
        env:
          DIGEST: ${{ steps.digest.outputs.digest }}
          SERVICE: ${{ steps.meta.outputs.service }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "### SIT âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- $SERVICE @ $DIGEST" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          TITLE="release-candidate"
          BODY=$'Service: '"$SERVICE"$'\nDigest: '"$DIGEST"$'\n\nSIT smoke tests complete.'

          gh label create "release-candidate" --color 0366d6 || true

          ISSUE=$(gh issue list --search "$TITLE in:title state:open" --json number --jq '.[0].number' || true)
          if [ -z "$ISSUE" ]; then
            gh issue create -t "$TITLE" -b "$BODY" -l release-candidate
          else
            gh issue comment "$ISSUE" -b "$BODY"
          fi

          PAYLOAD=$(jq -n --arg env "SIT" --arg service "$SERVICE" --arg url "http://api.${{ env.DOMAIN }}" \
            '{text:"SIT deployment complete",env:$env,service:$service,url:$url}')

          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -s -X POST -H 'content-type: application/json' --data "$PAYLOAD" "$SLACK_WEBHOOK_URL" || true
          else
            {
              echo "#### Slack (mock)"
              echo ""
              echo '```json'
              echo "$PAYLOAD"
              echo '```'
            } >> $GITHUB_STEP_SUMMARY
          fi

      - name: Deployment (SIT)
        uses: chrnorm/deployment-action@v2
        with:
          token: ${{ github.token }}
          environment: SIT
          ref: ${{ github.sha }}
          payload: "{\"service\":\"${{ steps.meta.outputs.service }}\",\"url\":\"http://sit-api.${{ env.DOMAIN }}\"}"
